{% extends "base.html" %}
{% block titel %}{{titel}}{%endblock%}
{% block content%}
<div id="backLoading">
    <div class="loader">
        <h1>Loading</h1>
    </div>
</div>
<div id='content' class="container">
    <!-- <div id='glowingButton' style="--clr:#22e622;--i:2;--fgc:#007710"><a href="#" >{{test}}</a></div> -->
    <div id="smallloading">
        <small>Getting data</small>
    </div>


    <p>hoi</p>
    <h5>{{test}}</h5>
    <p>Time past: <b id='time'></b></p>
    <small><pre id='data'></pre></small>
</div>
<script>
    $('#content').hide();
    $('#backLoading').show();
    var socket = io.connect('/');
    // var socket = io.connect('http://' + document.domain + ':' + location.port);
    $(document).ready(function() {
        socket.on('connect', function() {
            socket.emit('socket_connect');
        });        
    });
    function sec2time(timeInSeconds) {
        var pad = function(num, size) { return ('000' + num).slice(size * -1); },
        time = parseFloat(timeInSeconds).toFixed(3),
        hours = Math.floor(time / 60 / 60),
        minutes = Math.floor(time / 60) % 60,
        seconds = Math.floor(time - minutes * 60),
        milliseconds = time.slice(-3);
        if (hours > 0){
            return pad(hours, 2) + ':' + pad(minutes, 2) + ':' + pad(seconds, 2) + '.' + pad(milliseconds, 3);
        }else if (minutes > 0){
            return pad(minutes, 2) + ':' + pad(seconds, 2) + '.' + pad(milliseconds, 3);
        }else{
            return pad(seconds, 2) + '.' + pad(milliseconds, 3) + ' Sec.';
        }
    }


    socket.on('connected', () => {
        console.log('Websocket connected');
    });

    setInterval(()=> {  
        if (dataCount > 10) {
            Type = 'full';
            dataCount = 0;
        }
        else
            Type = 'small'
        socket.emit('getData', Jdata, Type);
        //$('#smallloading').show();  

    }, 1000);


    function mergeObject(oldObject, newObject){
        if (Jdata == startupJson || newObject.type == 'full'){
            oldObject = newObject;
        }
        else{
            Object.keys(newObject).forEach(function(x_itmes){
                if (typeof(newObject[x_itmes]) == 'object'){
                    Object.keys(newObject[x_itmes]).forEach(function(i_items){
                        oldObject[x_itmes][i_items] = newObject[x_itmes][i_items];});
                }else{
                    oldObject[x_itmes] = newObject[x_itmes];
                }
            });
        }
        return oldObject;
    }
    
    let oldtime;
    let newtime = 0;
    var oldClientTime = 0;
    var clientTime;
    var startupJson = JSON.parse('{"time":0}');
    var Jdata = startupJson;
    var Type = 'full';
    var dataCount = 0;
    //var old = 0.0;
    socket.on('data', function(data){
        dataCount++;
        oldtime = parseFloat(Jdata.time);
        // new data
        Jdata = mergeObject(Jdata, JSON.parse(data));
        
        newtime = parseFloat(Jdata.time);
        //console.log(data);
        const d = new Date();
        oldClientTime = (d.getTime() / 1000) - (newtime - oldtime);
        document.getElementById('data').innerHTML = JSON.stringify(Jdata, null, 2);
        $('#content').show();
        $('#backLoading').hide();
        $('#smallloading').hide();  
        document.getElementById("content").style.filter = `blur(0px)`;


    });

    setInterval(()=> {
        const d = new Date();
        clientTime = d.getTime() / 1000;
        //document.getElementById('time').innerHTML = parseFloat(parseInt((time/100)-oldtime*10)/10);
        //document.getElementById('time').innerHTML = parseFloat(parseInt((newtime-oldtime)*10)/10);
        //document.getElementById('time').innerHTML = parseFloat(parseInt((clientTime-oldClientTime)*10)/10);
        document.getElementById('time').innerHTML = sec2time(clientTime-oldClientTime);
    },100);

</script>

{% endblock %}